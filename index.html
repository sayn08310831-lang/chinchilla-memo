<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最強メモアプリ</title>

    <!-- PWA Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a202c"/>
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, query, where, writeBatch, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        window.Firebase = {
            initializeApp,
            getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, query, where, writeBatch, getDocs, serverTimestamp,
            getAuth, signInAnonymously, onAuthStateChanged
        };
    </script>

    <!-- React App Code -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            initializeApp, getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, query, where, writeBatch, getDocs,
            getAuth, signInAnonymously, onAuthStateChanged 
        } = window.Firebase;

        // --- Icon Placeholders ---
        const SimpleIcon = ({ children, className }) => <span className={`inline-block w-5 h-5 text-center leading-5 ${className}`}>{children}</span>;
        const Plus = () => <SimpleIcon className="font-bold">+</SimpleIcon>;
        const Edit = () => <SimpleIcon>✏️</SimpleIcon>;
        const Trash2 = () => <SimpleIcon>🗑️</SimpleIcon>;
        const Tag = (props) => <span {...props} className="inline-block w-5 h-5 text-center leading-5">🏷️</span>;
        const Inbox = () => <SimpleIcon>📥</SimpleIcon>;
        const Star = () => <SimpleIcon>⭐</SimpleIcon>;
        const Bell = () => <SimpleIcon>🔔</SimpleIcon>;
        const X = () => <SimpleIcon className="font-bold">×</SimpleIcon>;
        const ChevronRight = () => <SimpleIcon>▶</SimpleIcon>;
        const AlertCircle = () => <SimpleIcon>⚠️</SimpleIcon>;
        const Clock = () => <SimpleIcon>⏰</SimpleIcon>;
        const ChevronLeft = () => <SimpleIcon>◀</SimpleIcon>;
        const Sparkles = () => <SimpleIcon>✨</SimpleIcon>;

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyChlShN8ryo5eBAt4tjwd9IDDigMmXu2UQ",
            authDomain: "saikyomemo.firebaseapp.com",
            projectId: "saikyomemo",
            storageBucket: "saikyomemo.appspot.com",
            messagingSenderId: "721607935841",
            appId: "1:721607935841:web:64959527b9cf94580c2720",
            measurementId: "G-E9JW4DQQFZ"
        };
        const appId = 'default-memo-app';

        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // --- Sound Notification Helper ---
        const playNotificationSound = () => { /* ... (omitted for brevity, your code is fine) ... */ };

        // --- Gemini API Helper ---
        const callGeminiApi = async (prompt) => {
             console.warn("Gemini API is not configured. Returning a placeholder.");
             return "AI機能は現在準備中です。";
        };
        
        // --- Helper Functions ---
        const formatVisitTime = (startTimestamp, endTimestamp) => { /* ... (your function here) ... */ };
        const generateGoogleCalendarLink = (app) => { /* ... (your function here) ... */ };
        const getDateColorClass = (date) => { /* ... (your function here) ... */ };
        function getFilterName(filter, categories) { /* ... (your function here) ... */ }
        function formatDate(date) { /* ... (your function here) ... */ }
        function toDatetimeLocal(date) { /* ... (your function here) ... */ }


        // --- Components ---
        function ConfirmationModal({ isOpen, message, onConfirm, onCancel }) { /* ... (your component code) ... */ }
        function TeamIdEntry({ onTeamIdSubmit }) { /* ... (your component code) ... */ }
        function AppointmentCard({ app, onEdit, onDelete, onViewDetails, isDetailPage, isPast }) { /* ... (your component code) ... */ }
        function DetailPage({ salesPerson, appointments, onBack, onEdit, onDelete, onViewPast }) { /* ... (your component code) ... */ }
        function PastAppointmentsPage({ appointments, onBack, onEdit, onDelete, title, filterPerson }) { /* ... (your component code) ... */ }
        function Sidebar({ isOpen, categories, activeFilter, onFilterChange, onNewCategory, onEditCategory, onDeleteCategory }) { /* ... (your component code) ... */ }
        function SidebarItem({ icon, label, isActive, onClick, className = '' }) { /* ... (your component code) ... */ }
        function MemoList({ memos, onEdit, onDelete }) { /* ... (your component code) ... */ }
        function MemoCard({ memo, onEdit, onDelete }) { /* ... (your component code) ... */ }
        function MemoModal({ isOpen, onClose, onSave, memo, categories }) { /* ... (your component code) ... */ }
        function CategoryModal({ isOpen, onClose, onSave, category }) { /* ... (your component code) ... */ }
        function ReminderToast({ reminder, onDismiss }) { /* ... (your component code) ... */ }

        // --- Main App Component ---
        function App() {
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [memos, setMemos] = useState([]);
            const [categories, setCategories] = useState([]);
            const [activeFilter, setActiveFilter] = useState({ type: 'all', id: null });
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingMemo, setEditingMemo] = useState(null);
            const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);
            const [editingCategory, setEditingCategory] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [reminders, setReminders] = useState([]);

            // --- Auth Effect ---
            useEffect(() => {
                if (!auth) { setIsAuthReady(true); return; }
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        try { await signInAnonymously(auth); } catch (error) { console.error("Anonymous sign-in failed:", error); }
                    }
                    setIsAuthReady(true);
                });
                return () => unsubscribe();
            }, []);

            // --- Data Fetching Effects ---
            useEffect(() => {
                if (!isAuthReady || !userId || !db) return;
                const categoriesCollection = collection(db, `artifacts/${appId}/users/${userId}/categories`);
                const unsubscribeCategories = onSnapshot(categoriesCollection, (snapshot) => {
                    setCategories(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const memosCollection = collection(db, `artifacts/${appId}/users/${userId}/memos`);
                const unsubscribeMemos = onSnapshot(memosCollection, (snapshot) => {
                    setMemos(snapshot.docs.map(doc => ({
                        id: doc.id, ...doc.data(),
                        createdAt: doc.data().createdAt?.toDate(),
                        updatedAt: doc.data().updatedAt?.toDate(),
                        reminderAt: doc.data().reminderAt?.toDate(),
                    })));
                });
                return () => { unsubscribeCategories(); unsubscribeMemos(); };
            }, [isAuthReady, userId]);
            
            // --- Reminder Check Effect ---
            useEffect(() => { /* ... (your effect code) ... */ }, [memos, userId]);

            // --- Memo Filtering ---
            const filteredMemos = useMemo(() => { /* ... (your memo logic) ... */ }, [memos, activeFilter]);
            
            // --- Handlers ---
            const handleSaveMemo = async (memoData) => { /* ... (your handler code) ... */ };
            const handleDeleteMemo = async (memoId) => { /* ... (your handler code) ... */ };
            const handleSaveCategory = async (categoryData) => { /* ... (your handler code) ... */ };
            const handleDeleteCategory = async (categoryId) => { /* ... (your handler code) ... */ };
            const openModal = (memo = null) => { setEditingMemo(memo); setIsModalOpen(true); };
            const closeModal = () => setIsModalOpen(false);
            const openCategoryModal = (category = null) => { setEditingCategory(category); setIsCategoryModalOpen(true); };
            const closeCategoryModal = () => setIsCategoryModalOpen(false);
            const dismissReminder = (reminderId) => { setReminders(reminders.filter(r => r.id !== reminderId)); };

            if (!isAuthReady) {
                return <div className="flex items-center justify-center h-screen bg-gray-100 dark:bg-gray-900"><div className="text-lg">読み込み中...</div></div>;
            }

            return (
                <div className="flex h-screen bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans">
                    {/* ... (The full JSX from your App component's return statement) ... */}
                </div>
            );
        }

        // --- Final Render Call ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
    
    <!-- Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker: Registered'))
            .catch(err => console.error('Service Worker: Registration Failed', err));
        });
      }
    </script>
</body>
</html>